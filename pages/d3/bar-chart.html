<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>D3: A simple bar chart</title>
		<script src="https://d3js.org/d3.v4.min.js"></script>
        
        <style type="text/css">
			/* No style rules here yet */		
            svg {
                border: 1px solid black;
            }

            text.bar-text {
                font-family: sans-serif;
                font-size: .8em;
                fill: white;
                text-anchor: middle;
            }
            text.inner-bar-text {
                font-family: sans-serif;
                font-size: .8em;
                fill: black;
                text-anchor: middle;
            }
		</style>
    </head>
    
<body>

    <h1>Bar chart</h1>
    <button id="clickableBtn" type="button">Update bar chart</button>

<script>

// global setting for svg
// https://bl.ocks.org/mbostock/3019563
let margin = {
    top: 10, right: 10,
    bottom: 10, left: 10
};

let realW = 600,
    realH = 250;

let w = realW - margin.left - margin.right,
    h = realH - margin.top - margin.bottom;

let barPadding = 1;

var dataset = [ 5, 10, 13, 19, 21, 25, 22, 18, 15, 13,
                11, 12, 15, 20, 18, 17, 16, 18, 23, 25 ];

// Create scale
let xScale = d3.scaleBand()     // ordinal scale
    .domain(d3.range(dataset.length))
    .rangeRound([0, w])
    // .round(true) -> explicitly round up range
    .paddingInner(0.05);

let yScale = d3.scaleLinear()
    .domain([0, d3.max(dataset)])
    .range([0, h]);

// add listener
d3.select("#clickableBtn")
    .on("click", _ => {
        /*let dataset = [ 11, 12, 15, 20, 18, 17, 16, 18, 23, 25,
                    5, 10, 13, 19, 21, 25, 22, 18, 15, 13 ];*/
    
        let maxValue = 25;  // magic number
        let numValues = this.dataset.length;
        let dataset = []; //Initialize empty array
        for (var i = 0; i < numValues; i++) { //Loop numValues times
            var newNumber = Math.floor(Math.random() * maxValue); //New random integer (0-24)
            dataset.push(newNumber); //Add new number to array
        }

        //Update scale domain
        yScale.domain([0, d3.max(dataset)]);

        let dur = 1000;

        //Update all rects
        svg.selectAll("rect")
            .data(dataset)
            .transition()
            .delay( (d, i) => {
                // maximum delay for last element is 1 second
                return i / dataset.length * 1000;    // dynamic approch
            })
            .duration(dur)
            .ease(d3.easeLinear)
            .attr("y", function(d) {
                return h - yScale(d);
            })
            .attr("height", function(d) {
                return yScale(d);
            })
            .attr("fill", d => {
                return "rgb(0, 0, " + Math.round(d * 10) + ")";
            });

        svg.selectAll("text")
            .data(dataset)
            .transition()
            .delay( (d, i) => {
                return i / dataset.length * 1000;
            })
            .duration(dur)
            .ease(d3.easeLinear)
            .text(function(d) {
                return d;
            })
            .attr("x", function(d, i) {
                return xScale(i) + xScale.bandwidth() / 2;
            })
            .attr("y", function(d) {
                return d === 1 || d === 0 ?
                    h - yScale(d) - 4 : h - yScale(d) + 14;
            })
            .attr("class", d => {
                return d === 1 || d === 0 ? 
                    "inner-bar-text" : "bar-text";
            });
    });


//Create SVG element
let svg = d3.select("body")
            .append("svg")
            .attr("width", realW)
            .attr("height", realH)
            .append("g")
            .attr("id", "inner-svg")
            .attr("transform", "translate(" +
                            margin.left + "," +
                            margin.top + ")");

function drawBars(data) {

    svg.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("x", (d, i) => { return xScale(i)/*i * (w / dataset.length)*/; })
        .attr("y", d => { return h - yScale(d) /*(d * 4)*/; })
        .attr("width", xScale.bandwidth() /*w / dataset.length - barPadding*/)
        .attr("height", d => { return yScale(d); })
        .attr("fill", d => {
            return "rgb(0, 0, " + Math.round(d * 10) + ")";
        });
}

function drawLabels(data) {

    svg.selectAll("text")
        .data(data)
        .enter()
        .append("text")
        .text(d => { return d; })
        .attr("x", (d, i) => {
            return xScale(i) + xScale.bandwidth() / 2;
        })
        .attr("y", d => { return h - yScale(d) + 14; })
        .attr("class", "bar-text");
}


// init run
drawBars(dataset);
drawLabels(dataset);


</script>

</body>

</html>