<!DOCTYPE html>
<html>
<head>
    <title>Line Chart</title>
    <meta charset="utf-8" />
        
    <style>
        svg {
            border: 1px solid black;
        }

        .area {
            fill: teal;
            stroke: none;
        }

        .line {
            fill: none;
            stroke: teal;
            stroke-width: 0.5;
        }
        .safeLevel {
            stroke: red;
            stroke-dasharray: 2, 3;
        }

        .danger {
            stroke: red;
        }

        .dangerArea {
            fill: red;
        }
    </style>
    
    <script src="https://d3js.org/d3.v4.min.js"></script>

</head>

<body>
    <h1>Line chart example</h1>
    <svg id="line-chart"></svg>

    <h1>Area chart example</h1>
    <svg id="area-chart"></svg>

<script>

// globla variables
let mVal = 34;
let margin = {
    top: mVal, right: mVal,
    bottom: mVal, left: mVal
};

let realW = 600,
    realH = 250;

let w = realW - margin.left - margin.right,
    h = realH - margin.top - margin.bottom;

// create svg
//Create SVG element
function initSvg(name) {
    d3.select("#" + name)
        .attr("width", realW)
        .attr("height", realH)
        .append("g")
        .attr("id", "inner-" + name)
        .attr("transform", "translate(" +
                        margin.left + "," +
                        margin.top + ")");
}

initSvg("line-chart");
initSvg("area-chart");



function rowConverter(d) {
    return {
        date: new Date(+d.year, (+d.month - 1)),
        average: parseFloat(d.average)
    }
}

// load data
d3.csv("../data/mauna-loa-co2-mmd.csv", rowConverter, dataset => {

    console.table(dataset, ["date", "average"]);

    let xScale = d3.scaleTime()
        .domain([
            d3.min(dataset, d => { return d.date; }),
            d3.max(dataset, d => { return d.date; })
        ])
        .range([0, w])

    let yScale = d3.scaleLinear()
        .domain([
            d3.min(dataset, d => { if (d.average >= 0) return d.average; }), 
            d3.max(dataset, d => { return d.average; })
        ])
        .range([h, 0])

    // Define line generator function
    // the line must be generated by infinite points between 
    // dataset points
    let lineGenerator = d3.line()
        // some data have no average co2 measure, filter them
        .defined(d => { return d.average >= 0 && d.average <= 350; })    
        .x(d => { return xScale(d.date); })
        .y(d => { return yScale(d.average); })

    let dangerLineGen = d3.line()
        .defined(d => { return d.average >= 350; })
        .x(d => { return xScale(d.date); })
        .y(d => { return yScale(d.average); });

    //Define axes
    xAxis = d3.axisBottom()
        .scale(xScale)
        .ticks(10)
        .tickFormat(d3.timeFormat("%Y"));
    
    yAxis = d3.axisLeft()
        .scale(yScale)
        .ticks(10);


    // ** Draw on SVG 

    let svg = d3.select("#inner-line-chart");

    // Add axes
    svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + h + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0,0)")
        .call(yAxis); 

    svg.append("path")
        // we need only one (datum) <path> element
        // datum binds a single data value
        .datum(dataset)
        .attr("class", "line")
        // the line generator simply grabs that data, 
        // plots the points as we specified, 
        // and draws a line connecting them
        .attr("d", lineGenerator)

    svg.append("path")
        .datum(dataset)
        .attr("class", "line danger")
        .attr("d", dangerLineGen);

    //Draw 350 ppm line
    svg.append("line")
        .attr("class", "line safeLevel")
        .attr("x1", 0)
        .attr("x2", w)
        .attr("y1", yScale(350))
        .attr("y2", yScale(350));

    //Label 350 ppm line
    svg.append("text")
        .attr("class", "dangerLabel")
        .attr("x", 20)
        .attr("y", yScale(350) - 7)
        .text("350 ppm “safe” level");


    // AREA CHART 

    let areaGen = d3.area()
        .defined(d => { return d.average >= 0; })
        // same x
        .x(d => { return xScale(d.date); })
        // area baseline (y bottom)
        .y0(() => { 
            // take the minimum of y axis
            return yScale.range()[0]; 
        })
        // y top or data value
        .y1(d => { return yScale(d.average); });    

    let dangerAreaGen = d3.area()
        .defined(d => { return d.average >= 350; })
        .x(d => { return xScale(d.date); })
        // baseline
        .y0(() => { return yScale(350); })
        .y1(d => { return yScale(d.average); });

    // Update SVG

    let svgArea = d3.select("#inner-area-chart");

    svgArea.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + h + ")")
        .call(xAxis);

    svgArea.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0,0)")
        .call(yAxis); 

    svgArea.append("path")
        .datum(dataset)
        .attr("class", "area")
        .attr("d", areaGen);

    svgArea.append("path")
        .datum(dataset)
        .attr("class", "area dangerArea")
        .attr("d", dangerAreaGen);

});


</script>
        
        
</body>

</html> 